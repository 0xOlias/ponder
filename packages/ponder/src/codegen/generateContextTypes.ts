import { writeFile } from "node:fs/promises";
import path from "node:path";

import { CONFIG } from "@/config";
import { DbSchema, PonderConfig, SourceKind } from "@/types";
import { formatPrettier, logger } from "@/utils";

const header = `
/* Autogenerated file. Do not edit manually. */
`;

const generateContextTypes = async (
  config: PonderConfig,
  dbSchema: DbSchema
) => {
  const entityNames = dbSchema.tables.map((table) => table.name);
  const contractNames = config.sources
    .filter((source) => source.kind === SourceKind.EVM)
    .map((source) => source.name);

  const entityQueryBuilderTypes = entityNames
    .map(
      (entityName) => `${entityName}: () => Knex.QueryBuilder<${entityName}>;`
    )
    .join("");

  const contractTypes = contractNames
    .map((contractName) => `${contractName}: ${contractName};`)
    .join("");

  const imports = `
  import type { Knex } from "knex";
  
  import type { ${entityNames.join(", ")} } from "./schema";
  import type { ${contractNames.join(", ")} } from "./typechain";
  `;

  const body = `
  export type Context = {
    entities: {
      ${entityQueryBuilderTypes}
    }
    contracts: {
      ${contractTypes}
    }
  }
  `;

  const final = formatPrettier(header + imports + body);

  await writeFile(
    path.join(CONFIG.GENERATED_DIR_PATH, "context.d.ts"),
    final,
    "utf8"
  );

  logger.info(`\x1b[36m${"GENERATED CONTEXT TYPES"}\x1b[0m`); // magenta
};

export { generateContextTypes };
